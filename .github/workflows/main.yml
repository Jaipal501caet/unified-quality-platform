name: Unified Quality Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:      # ðŸŸ¢ THIS ADDS THE BUTTON ðŸŸ¢
jobs:
  # ==================================================================
  # STAGE 1: Playwright (Hybrid Functional Test)
  # ==================================================================
  playwright-ui:
    name: ðŸŽ­ UI & API Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Equivalent to: docker compose build e2e
      - name: Build UI Container
        run: docker compose build e2e

      # Equivalent to: docker compose run --rm e2e ...
      # We use /bin/bash (standard Linux) instead of //bin/bash (Windows)
      - name: ðŸ§ª Run Playwright Suite
        run: |
          docker compose run --rm e2e /bin/bash -c "npm install && npx playwright test tests/e2e/hybrid_login.spec.ts"

      - name: ðŸ›‘ Teardown
        if: always()
        run: docker compose down

      - name: ðŸ“¤ Upload UI Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: test-results/
          retention-days: 30

  # ==================================================================
  # STAGE 2: K6 (Performance Test)
  # ==================================================================
  k6-load-test:
    name: âš¡ K6 Load Test
    # This 'needs' keyword creates the visual pipeline connection
    needs: playwright-ui
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Equivalent to: docker compose build k6
      - name: Build K6 Container
        run: docker compose build k6

      # Equivalent to: docker compose run --rm k6 ...
      # Note: We use /src/ because your docker-compose maps . to /src
      - name: ðŸ”¥ Run K6 Load Test
        run: |
          docker compose run --rm k6 run /src/tests/performance/register_load_test.js

      - name: ðŸ›‘ Teardown
        if: always()
        run: docker compose down

      - name: ðŸ“¤ Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: test-results/
