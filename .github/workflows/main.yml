name: Unified Quality Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # This environment variable is available to all jobs
  BASE_URL: "https://parabank.parasoft.com/parabank"

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: UI & Functional Testing (Playwright)
  # ------------------------------------------------------------------
  playwright-ui:
    name: ðŸŽ­ UI & API Verification
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # We use Docker directly instead of installing Node.js locally.
      # This ensures the test runs exactly like it does on your machine.
      - name: Build Containers
        run: docker compose build

      - name: Run Playwright Container
        # Runs the 'playwright' service defined in your docker-compose.yml
        # Exits automatically if the tests fail
        run: docker compose up --exit-code-from playwright playwright

      - name: ðŸ›‘ Teardown (Cleanup)
        if: always()
        run: docker compose down

      - name: ðŸ“¤ Upload UI Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

  # ------------------------------------------------------------------
  # STAGE 2: Load Testing (K6)
  # ------------------------------------------------------------------
  k6-load-test:
    name: âš¡ K6 Load Test
    # ðŸŸ¢ THIS LINE creates the "Pipeline" visual ðŸŸ¢
    # It tells GitHub: "Don't start this until 'playwright-ui' passes"
    needs: playwright-ui
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Containers
        run: docker compose build

      - name: Run K6 Load Test
        # Runs the 'k6' service defined in your docker-compose.yml
        run: docker compose up --exit-code-from k6 k6

      - name: ðŸ›‘ Teardown (Cleanup)
        if: always()
        run: docker compose down

      - name: ðŸ“¤ Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-report
          path: test-results/
