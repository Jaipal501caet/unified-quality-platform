import { test, expect } from '@playwright/test';
import { ApiController } from '../../src/api/apiController';
// We import the new DB controller
import { DbController } from '../../src/db/dbController'; 

test.describe('Phase 2: Hybrid Automation (API + UI + DB)', () => {

  // Declare DB controller
  let db: DbController;

  test.beforeEach(async () => {
    // Initialize DB connection before test runs
    db = new DbController();
    await db.connect();
  });

  test.afterEach(async () => {
    // Teardown DB connection after test finishes
    await db.close();
  });

  test('Should create user via API, Login via UI, and Verify in DB', async ({ page, request }) => {

    // --- PART 1: API LAYER ---
    const api = new ApiController(request);
    await api.checkHealth();
    
    // Create User via API
    const username = 'demo_user';
    await api.createUser(username);

    // --- PART 2: UI LAYER ---
    console.log('[UI] Navigating to Login Page...');
    await page.goto('/'); // Uses baseURL from playwright.config.ts

    // Perform UI Actions
    await page.fill('input[name="username"]', 'john');
    await page.fill('input[name="password"]', 'demo');
    await page.click('input[value="Log In"]');
    
    // Verify UI
    await expect(page).toHaveTitle(/ParaBank/);
    console.log('[UI] Page Title Verified');

    // --- PART 3: DB LAYER ---
    // Validate the data is actually safe in the database
    const isUserPresent = await db.verifyUserCreated(username);
    expect(isUserPresent).toBeTruthy();
    console.log('[DB] User record verification passed');
  });
});
